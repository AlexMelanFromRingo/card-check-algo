<div class="page">
  <header class="hero">
    <div class="hero__content">
      <p class="kicker">Алгоритм Луна (Luhn)</p>
      <h1>Проверка номера карты — честно, по шагам и без магии.</h1>
      <p class="lead">
        Введите номер карты (или тестовое значение) и посмотрите, как алгоритм проверяет корректность.
        Это демонстрация — не храним данные и ничего не отправляем.
      </p>
      <div class="hero__actions">
        <button class="btn btn--primary" type="button" (click)="setExample()">Показать пример</button>
        <button class="btn btn--ghost" type="button" (click)="clear()">Очистить</button>
      </div>
    </div>
    <div class="hero__card">
      <div class="card">
        <div class="card__chip"></div>
        <div class="card__number">{{ formatted() || '0000 0000 0000 0000' }}</div>
        <div class="card__meta">
          <span>VALIDITY</span>
          <strong>{{ isValid() ? 'VALID' : 'CHECK' }}</strong>
        </div>
      </div>
    </div>
  </header>

  <section class="panel">
    <div class="panel__input">
      <label for="cardNumber">Номер карты</label>
      <input
        id="cardNumber"
        type="text"
        inputmode="numeric"
        autocomplete="off"
        placeholder="Введите номер"
        [ngModel]="rawInput()"
        (ngModelChange)="onInputChange($event)"
        maxlength="23"
      />
      <p class="hint">Используйте только цифры. Можно вставить с пробелами — мы их удалим.</p>
    </div>

    <div class="panel__result">
      <div class="result">
        <div class="result__label">Статус проверки</div>
        <div class="result__value" [class.ok]="isValid()" [class.bad]="!isValid() && digits().length >= 12 && digits().length <= 19">
          {{ digits().length < 12 ? 'Слишком короткий' : (digits().length > 19 ? 'Слишком длинный' : (isValid() ? 'Корректен' : 'Некорректен')) }}
        </div>
      </div>
      <div class="result">
        <div class="result__label">Длина номера</div>
        <div class="result__value">{{ lengthStatus() }}</div>
        <div class="result__sub">Обычно 12–19 цифр для банковских карт.</div>
      </div>
      <div class="result">
        <div class="result__label">Сумма по алгоритму</div>
        <div class="result__value">{{ total() }}</div>
      </div>
      <div class="result" *ngIf="checkDigit() !== null">
        <div class="result__label">Ожидаемая контрольная цифра</div>
        <div class="result__value">{{ checkDigit() }}</div>
      </div>
    </div>
  </section>

  <section class="steps">
    <h2>Как работает алгоритм Луна</h2>
    <p class="steps__lead">
      Классическое описание идёт справа налево (от контрольной цифры). Мы показываем таблицу слева направо,
      но правило удвоения выбираем по чётности длины, поэтому результат идентичен.
    </p>
    <ol>
      <li>Считаем справа налево. Последняя цифра — контрольная, она тоже участвует в сумме.</li>
      <li>Каждую вторую цифру (через одну, считая справа) удваиваем.</li>
      <li>Если удвоение дало число больше 9, вычитаем 9 (это то же, что сложить его цифры).</li>
      <li>Складываем все числа: и удвоенные, и те, что не удваивали.</li>
      <li>Если сумма кратна 10 — номер корректен.</li>
    </ol>
    <div class="steps__note">
      Эквивалентное правило слева направо: если длина чётная — удваиваем 1-ю, 3-ю, 5-ю…,
      если нечётная — 2-ю, 4-ю, 6-ю…
    </div>
    <div class="steps__note steps__note--muted">
      Длина номера банковской карты обычно 12–19 цифр. Алгоритм Луна проверяет структуру,
      но не подтверждает реальность карты.
    </div>
  </section>

  <section class="table">
    <h2>Пошаговый разбор</h2>
    <p class="table__lead">
      Нумерация идёт слева направо для удобства чтения, но решение «удваивать или нет» соответствует счёту справа.
    </p>
    <div class="table__controls">
      <span>Показать порядок:</span>
      <button class="chip" type="button" [class.active]="mode() === 'rtl'" (click)="setMode('rtl')">Справа налево</button>
      <button class="chip" type="button" [class.active]="mode() === 'ltr'" (click)="setMode('ltr')">Слева направо</button>
    </div>
    <div class="table__head">
      <span>#</span>
      <span>Цифра</span>
      <span>Удваиваем?</span>
      <span>Результат</span>
    </div>
    <div class="table__row" *ngFor="let step of displaySteps()">
      <span>{{ mode() === 'rtl' ? step.positionFromRight : step.positionFromLeft }}</span>
      <span>{{ step.digit }}</span>
      <span class="pill" [class.pill--active]="step.doubled">{{ step.doubled ? 'Да' : 'Нет' }}</span>
      <span>{{ step.result }}</span>
    </div>
  </section>

  <section class="note">
    <h2>Почему это работает</h2>
    <p>
      Алгоритм Луна добавляет «контрольную» цифру, которая зависит от остальных. Благодаря этому
      большинство случайных ошибок ввода (перепутали цифру, пропустили символ) приводит к некратной 10 сумме.
      Это не защита от мошенников, а быстрый способ отловить опечатки. Проверка работает для номеров длиной
      от 12 до 19 цифр, что типично для банковских карт.
    </p>
  </section>
</div>
