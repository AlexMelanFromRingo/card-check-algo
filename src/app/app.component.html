<div class="page" [class.theme-dark]="theme() === 'dark'">
  <header class="hero">
    <div class="hero__content">
      <p class="kicker">Алгоритм Луна (Luhn)</p>
      <h1>Проверка номера карты — честно, по шагам и без магии.</h1>
      <p class="lead">
        Введите номер карты (или тестовое значение) и посмотрите, как алгоритм проверяет корректность.
        Это демонстрация — не храним данные и ничего не отправляем.
      </p>
      <div class="hero__actions">
        <button class="btn btn--primary" type="button" (click)="setExample()">Показать пример</button>
        <button class="btn btn--ghost" type="button" (click)="clear()">Очистить</button>
        <button class="btn btn--ghost" type="button" (click)="toggleTheme()">
          Тема: {{ theme() === 'light' ? 'Светлая' : 'Тёмная' }}
        </button>
      </div>
    </div>
    <div class="hero__card">
      <div class="card">
        <div class="card__chip"></div>
        <div class="card__number card__number--digits">
          <ng-container *ngIf="digits().length > 0; else emptyDigits">
            <ng-container *ngFor="let step of luhnSteps(); index as idx">
              <span
                class="digit"
                [class.digit--double]="step.doubled"
                [class.digit--spotlight]="hoveredIndex() === step.index"
                (mouseenter)="setHovered(step.index)"
                (mouseleave)="setHovered(null)"
              >
                {{ step.digit }}
              </span>
              <span class="digit__spacer" *ngIf="(idx + 1) % 4 === 0"> </span>
            </ng-container>
          </ng-container>
          <ng-template #emptyDigits>0000 0000 0000 0000</ng-template>
        </div>
        <div class="card__meta">
          <span>VALIDITY</span>
          <strong>{{ isValid() ? 'VALID' : 'CHECK' }}</strong>
        </div>
      </div>
    </div>
  </header>

  <section class="panel">
    <div class="panel__input">
      <label for="cardNumber">Номер карты</label>
      <input
        id="cardNumber"
        type="text"
        inputmode="numeric"
        autocomplete="off"
        placeholder="Введите номер"
        [ngModel]="rawInput()"
        (ngModelChange)="onInputChange($event)"
        maxlength="23"
      />
      <p class="hint">Используйте только цифры. Можно вставить с пробелами — мы их удалим.</p>
    </div>

    <div class="panel__result">
      <div class="result">
        <div class="result__label">Статус проверки</div>
        <div class="result__value" [class.ok]="isValid()" [class.bad]="!isValid() && digits().length >= 12 && digits().length <= 19">
          {{ digits().length < 12 ? 'Слишком короткий' : (digits().length > 19 ? 'Слишком длинный' : (isValid() ? 'Корректен' : 'Некорректен')) }}
        </div>
      </div>
      <div class="result">
        <div class="result__label">Длина номера</div>
        <div class="result__value">{{ lengthStatus() }}</div>
        <div class="result__sub">Обычно 12–19 цифр для банковских карт.</div>
      </div>
      <div class="result">
        <div class="result__label">Сумма по алгоритму</div>
        <div class="result__value">{{ total() }}</div>
      </div>
      <div class="result" *ngIf="checkDigit() !== null">
        <div class="result__label">Ожидаемая контрольная цифра</div>
        <div class="result__value">{{ checkDigit() }}</div>
      </div>
    </div>
  </section>

  <section class="steps">
    <h2>Как работает алгоритм Луна</h2>
    <p class="steps__lead">
      Классическое описание идёт справа налево (от контрольной цифры). Мы показываем таблицу слева направо,
      но правило удвоения выбираем по чётности длины, поэтому результат идентичен.
    </p>
    <ol>
      <li>Считаем справа налево. Последняя цифра — контрольная, она тоже участвует в сумме.</li>
      <li>Каждую вторую цифру (через одну, считая справа) удваиваем.</li>
      <li>Если удвоение дало число больше 9, вычитаем 9 (это то же, что сложить его цифры).</li>
      <li>Складываем все числа: и удвоенные, и те, что не удваивали.</li>
      <li>Если сумма кратна 10 — номер корректен.</li>
    </ol>
    <div class="steps__note">
      Эквивалентное правило слева направо: если длина чётная — удваиваем 1-ю, 3-ю, 5-ю…,
      если нечётная — 2-ю, 4-ю, 6-ю…
    </div>
    <div class="steps__note steps__note--muted">
      Длина номера банковской карты обычно 12–19 цифр. Алгоритм Луна проверяет структуру,
      но не подтверждает реальность карты.
    </div>
  </section>

  <section class="tutorial">
    <h2>Учебный режим</h2>
    <p class="tutorial__lead">Прокликайте шаги, чтобы по очереди разобрать процесс.</p>
    <div class="tutorial__card">
      <div class="tutorial__step">Шаг {{ tutorialIndex() + 1 }} из {{ tutorialSteps.length }}</div>
      <h3>{{ currentTutorial().title }}</h3>
      <p>{{ currentTutorial().body }}</p>
      <div class="tutorial__actions">
        <button class="btn btn--ghost" type="button" (click)="prevTutorial()" [disabled]="tutorialIndex() === 0">Назад</button>
        <button class="btn btn--primary" type="button" (click)="nextTutorial()" [disabled]="tutorialIndex() === tutorialSteps.length - 1">
          Вперёд
        </button>
      </div>
    </div>
  </section>

  <section class="table">
    <h2>Пошаговый разбор</h2>
    <p class="table__lead">
      Нумерация идёт слева направо для удобства чтения, но решение «удваивать или нет» соответствует счёту справа.
    </p>
    <div class="table__controls">
      <span>Показать порядок:</span>
      <button class="chip" type="button" [class.active]="mode() === 'rtl'" (click)="setMode('rtl')">Справа налево</button>
      <button class="chip" type="button" [class.active]="mode() === 'ltr'" (click)="setMode('ltr')">Слева направо</button>
    </div>
    <div class="table__head">
      <span>#</span>
      <span>Цифра</span>
      <span>Удваиваем?</span>
      <span>Результат</span>
    </div>
    <div
      class="table__row"
      *ngFor="let step of displaySteps()"
      [class.table__row--spotlight]="hoveredIndex() === step.index"
      (mouseenter)="setHovered(step.index)"
      (mouseleave)="setHovered(null)"
    >
      <span>{{ mode() === 'rtl' ? step.positionFromRight : step.positionFromLeft }}</span>
      <span>{{ step.digit }}</span>
      <span class="pill" [class.pill--active]="step.doubled">{{ step.doubled ? 'Да' : 'Нет' }}</span>
      <span>{{ step.result }}</span>
    </div>
  </section>

  <section class="sum">
    <h2>Суммирование и проверка</h2>
    <p class="sum__lead">
      Складываем результаты по всем позициям (и удвоенным, и обычным), затем проверяем кратность 10.
    </p>
    <div class="sum__box">
      <div class="sum__row">
        <span class="sum__label">Сумма</span>
        <span class="sum__expr">
          <ng-container *ngFor="let value of sumExpression(); index as idx">
            <span class="sum__term" [style.--delay]="(idx * 0.05) + 's'">{{ value }}</span>
            <span class="sum__plus" *ngIf="idx < sumExpression().length - 1"> + </span>
          </ng-container>
          = <strong>{{ total() }}</strong>
        </span>
      </div>
      <div class="sum__row">
        <span class="sum__label">Проверка</span>
        <span class="sum__expr">
          {{ total() }} mod 10 = <strong>{{ sumRemainder() }}</strong>
          <span class="sum__badge" [class.ok]="isValid()" [class.bad]="!isValid() && digits().length >= 12 && digits().length <= 19">
            {{ isValid() ? 'Кратно 10' : 'Не кратно 10' }}
          </span>
        </span>
      </div>
    </div>
  </section>

  <section class="note">
    <h2>Почему это работает</h2>
    <p>
      Алгоритм Луна добавляет «контрольную» цифру, которая зависит от остальных. Благодаря этому
      большинство случайных ошибок ввода (перепутали цифру, пропустили символ) приводит к некратной 10 сумме.
      Это не защита от мошенников, а быстрый способ отловить опечатки. Проверка работает для номеров длиной
      от 12 до 19 цифр, что типично для банковских карт.
    </p>
  </section>
</div>
